import groovy.json.JsonSlurper

node {
  stage ("deploy") {
    
    checkout scm
    withCredentials(bindings: [sshUserPrivateKey(credentialsId: "cloud-netstorage",
                      keyFileVariable: "privateKeyFile",
                      passphraseVariable: "",
                      usernameVariable: "")]) {

      String APP_NAME = "__APP_NAME__"
      String BRANCH = env.BRANCH_NAME.replaceAll("origin/", "")

      if (BRANCH == "prod-stable") {
        PREFIX = "apps"
      } else if (BRANCH == "prod-beta") {
        PREFIX = "beta/apps"
      } else {
        error "Bug: invalid branch name, we only support prod-beta/prod-stable and we got ${BRANCH}"
      }

      // Write build info into app.info.json
      // We have the src info there already
      def app_info = readJSON file: "./app.info.json"
      app_info.build_branch = BRANCH
      app_info.build_hash = sh(returnStdout: true, script: 'git rev-parse HEAD').trim()
      app_info.build_id = env.BUILD_ID
      writeJSON file: "./app.info.json", json: app_info

      // Get the index paths using index_map.json
      def index_map = readJSON file: "./index_map.json"
      def index_path_list = []
      for(def entry : index_map) {
          if(entry.real_path == app_info.app_name) {
              index_path_list.add(entry.req_path)
          }
      }

      // Send Slack Notification
      String SLACK_TEXT = "${APP_NAME}/${BRANCH} [STATUS] - Deploy build ${app_info.build_id} started for GIT COMMIT ${app_info.build_hash}."
      slackSend message: SLACK_TEXT, color: 'black', channel: '#insights-bots'

      AKAMAI_BASE_PATH = "/822386"
      AKAMAI_APP_PATH = "${AKAMAI_BASE_PATH}/${PREFIX}/${APP_NAME}"

      configFileProvider([configFile(fileId: "9f0c91bc-4feb-4076-9f3e-13da94ff3cef", variable: "AKAMAI_HOST_KEY")]) {
        for(def index_path : index_path_list) {
          sh """
            rsync -arv -e \"ssh -2\" index.html sshacs@cloud-unprotected.upload.akamai.com:${AKAMAI_BASE_PATH}/${index_path}
          """
        }
        sh """
           eval `ssh-agent`
           ssh-add \"$privateKeyFile\"
           cp $AKAMAI_HOST_KEY ~/.ssh/known_hosts
           chmod 600 ~/.ssh/known_hosts
           rsync -arv -e \"ssh -2\" * sshacs@cloud-unprotected.upload.akamai.com:${AKAMAI_APP_PATH}
         """
      }
    }
  }
}